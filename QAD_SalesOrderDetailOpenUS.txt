"SELECT 
	  sod_det.sod_domain DomainCode, 
       cm_mstr.cm_region Region, 
       cm_mstr.cm_slspsn_ex1 TMCode, 
       ad_mstr_sales.ad_name TMName, 
       so_mstr.so_ord_date OrderDate, 
       so_mstr.so_compl_stat CompleteStatus, 
       sod_det.sod_due_date DueDate, 
       sod_det.sod_promise_date Promise, 
       so_mstr.so_cust 'SoldToCustomerCode', 
       cm_mstr.cm_sort 'CustomerName', 
       sod_det.sod_line 'SalesOrderLine', 
       sod_det.sod_part 'ItemNumber', 
       pt_mstr.pt_desc1 + pt_mstr.pt_desc2 'Description', 
       sod_det.sod_qty_ord - sod_det.sod_qty_ship 'QtyOpen', 
       sod_det.sod_qty_all 'QtyAllocated', 
       sod_det.sod_um 'UM', 
       sod_det.sod_price 'Price', 
	   case WHEN um.um_part IS NOT NULL
                     AND sod_um <> 'EA'
                THEN sod_qty_ord / um.um_conv
                WHEN um2.um_part IS NOT NULL
                     AND sod_um <> 'EA'
                THEN sod_qty_ord * um2.um_conv
                WHEN(um.um_part IS NULL
                     OR sod_qty_ord IS NULL)
                THEN sod_qty_ord
                ELSE sod_qty_ord
	   END 'Quantity_EA',
       (sod_det.sod_qty_ord - sod_det.sod_qty_ship) * sod_det.sod_price 'ExtPrice', 
       pt_mstr.pt_promo 'QuotaGroup', 
       so_mstr.so_ship 'Shipto', 
       ad_mstr_ship.ad_name 'Shipto Name', 
       ad_mstr_ship.ad_line1 'Address Line1', 
       ad_mstr_ship.ad_line2 'Address Line2', 
       ad_mstr_ship.ad_city 'City', 
       ad_mstr_ship.ad_state 'State', 
       so_mstr.so_nbr 'SalesOrder', 
       so_mstr.so_po 'PurchaseOrder', 
       so_mstr.so_stat 'Status', 
       so_mstr.so_rmks 'Remarks', 
       ad_mstr_ship.ad_ctry 'Country', 
       pt_promo 'Promo',
	   cm_slspsn_ex2 'VCCode',
	   CASE WHEN sod_det.sod_site = '140' THEN 'Plan2021|Wheeling'--'CPS-WHL'
		    WHEN sod_det.sod_site = '160' THEN 'Plan2021|Rochester'--'CPS-RCH'
			WHEN cm_mstr.cm_region  >= '1110' and cm_mstr.cm_region <= '1155' THEN 'Plan2021|CPS-OEM' --'CPS-ATH'
			WHEN ((cm_mstr.cm_region  >= '1101' and cm_mstr.cm_region <= '1106') or cm_mstr.cm_region = '9999') AND x.xxpt_part IS NOT NULL THEN 'Plan2021|US PICC'--'US PICC' 
			WHEN ((cm_mstr.cm_region  >= '1101' and cm_mstr.cm_region <= '1106') or cm_mstr.cm_region = '9999') AND x.xxpt_part IS NULL THEN 'Plan2021|US SF' --'US Sales'
			WHEN cm_mstr.cm_region = '1301' and cm_mstr.cm_region <= '1155' THEN  'Plan2021|CPS-OEM'--'CPS-ATH'
			WHEN cm_mstr.cm_region = '1301' OR (cm_mstr.cm_region = '1113' AND x.xxpt_part IS NOT NULL) THEN 'Plan2021|LA'--'Latin America'
			WHEN cm_mstr.cm_region >= '4000' AND  cm_mstr.cm_region <= '4099' THEN 'Plan2021|EMEA Dist Act'--'EMEA'
			WHEN cm_mstr.cm_region = '1201' THEN 'Plan2021|Canada'--'Canada'
			WHEN cm_mstr.cm_region = '2101' THEN 'Plan2021|China Direct'--'China'
			WHEN cm_mstr.cm_region = '2111' THEN 'Plan2021|Hong Kong'--'Hong Kong'
			WHEN cm_mstr.cm_region >= '2001' AND cm_mstr.cm_region <= '2999'  THEN 'Plan2021|JOA'--'APAC'
			END GeographyKey
FROM sod_det(NOLOCK)
     JOIN so_mstr(NOLOCK) ON sod_det.sod_domain = so_mstr.so_domain
                             AND sod_nbr = so_nbr
	 JOIN um_mstr(NOLOCK) ON um_domain = sod_domain 
							 AND um_part = sod_part and um_alt_um = sod_um
     JOIN pt_mstr(NOLOCK) ON sod_domain = pt_domain
                             AND sod_part = pt_part
     JOIN ad_mstr ad_mstr_ship(NOLOCK) ON ad_domain = so_domain
                                          AND ad_addr = so_ship
     LEFT JOIN cm_mstr(NOLOCK) ON so_domain = cm_domain
                                  AND so_cust = cm_addr
     LEFT JOIN ad_mstr ad_mstr_sales(NOLOCK) ON ad_mstr_sales.ad_domain = so_domain
                                                AND ad_mstr_sales.ad_addr = cm_mstr.cm_slspsn_ex1
	 LEFT JOIN (select xxpt_part FROM xxpt_mstr (nolock) where xxpt_domain = '100USD'
                                     and xxpt_mkt_class =   'PICCMidlineCath')x ON pt_part= x.xxpt_part
	 LEFT JOIN [dbo].[um_mstr] um(NOLOCK) ON sod_domain = um.um_domain
                                                  AND sod_um = um.um_um
                                                  AND sod_part = um.um_part
                                                  AND um.um_alt_um = 'EA'
LEFT JOIN
     (
         SELECT um_domain, 
                um_part, 
                um_alt_um, 
                um_conv
         FROM [dbo].[um_mstr](NOLOCK)
         WHERE(um_alt_um <> 'EA'
               AND um_um = 'EA')
         GROUP BY um_domain, 
                  um_part, 
                  um_alt_um, 
                  um_conv
     ) um2 ON sod_domain = um2.um_domain
              AND sod_um = um2.um_alt_um
              AND sod_part = um2.um_part
              AND um2.um_alt_um <> 'EA'
WHERE 1 = 1
      AND sod_det.sod_domain = '100USD'
      AND sod_det.sod_site IN('100', '140')
     AND sod_det.sod_prodline <> ''
     AND sod_det.sod_price <> 0
     AND pt_mstr.pt_part <> '3935'
     AND pt_mstr.pt_prod_line <> '7900'
     AND so_mstr.so_compl_stat <> '01'
     AND so_mstr.so_cust = cm_mstr.cm_addr
     AND so_mstr.so_compl_stat <> '01'
     AND cm_mstr.cm_region <> 1301
     AND sod_det.sod_qty_ord - sod_det.sod_qty_ship <> 0
     and ISNULL(pt_mstr.pt_promo,'') not IN ('EDC','NONE','PROCTRAY')
--and cm_mstr.cm_slspsn_ex1 = 12401600
--sod_nbr = '2193598'
"